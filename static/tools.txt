SMART TRAFFIC VIOLATION PRIORITY ENGINE | AI-POWERED EMERGENCY RESPONSE
TECHNICAL DOCUMENTATION

This document provides a comprehensive list of the tools, libraries, and core functions that power the Smart Traffic Violation Priority Engine.

1. CORE LIBRARIES & TOOLS
-------------------------
- Python 3.x: The primary programming language.
- Streamlit: The framework used to build the professional web-based Command Center and Dashboard.
- OpenCV (cv2): Used for high-performance video frame reading, resizing, and real-time HUD rendering (drawing boxes, text, and brackets).
- Ultralytics (YOLOv8): The state-of-the-art Deep Learning model used for real-time vehicle detection and classification.
- ByteTrack: The tracking algorithm integrated with YOLO to maintain 95%+ persistence of vehicle IDs across frames.
- NumPy: Used for advanced mathematical operations, array processing, and calculating weighted moving averages for speed.
- Collections (deque): Used for memory-efficient data buffers to store vehicle history, speed samples, and violation logs.
- Math: Used for trigonometry and Euclidean distance calculations required for speed and proximity analysis.
- Base64 & JavaScript: Used to bridge Python with the browser for triggering audible siren alerts and the live IST clock.

2. KEY SYSTEM FUNCTIONS
-----------------------
- trigger_siren(): 
  A JavaScript-injected function that plays a professional police siren sound for 5 seconds when critical threats are detected. It uses a unique key system to bypass browser audio blocks.

- inject_live_clock():
  A client-side JavaScript component that displays a synchronized real-time clock in the top-right corner. It calculates Indian Standard Time (IST) and updates every second independent of the AI processing loop.

- load_model(): 
  Uses Streamlit's @st.cache_resource to load the YOLOv8 model into memory once, ensuring the system starts fast and runs efficiently.

- get_officer_advisory(v_type, v_name, speed, tid): 
  The "AI Brain" for decision support. It analyzes violation data and generates humanized, actionable instructions for law enforcement (e.g., "Dispatch Interceptor").

- process_vehicle_logic(tid, cx, cy, t, w, h_frame): 
  The core engine of the system. It performs:
  * Quadratic Perspective Scaling: Adjusts speed math based on the vehicle's depth in the camera view.
  * Weighted Moving Average: Smooths out speed jitter for realistic KM/H readings.
  * Lane Detection: Tracks which side of the divider a car is on.
  * Violation Consensus: Ensures a violation is real before triggering an alert.

- analyze_safety(detections, h_frame): 
  The Proximity Engine. It compares every vehicle against every other vehicle to detect:
  * Tailgating: Calculates real-world gap in meters vs. travel speed.
  * Collision Prediction: Projects movement vectors 12 frames into the future to identify intersecting paths.

- run_engine(): 
  The main execution loop. It manages:
  * AI Inference: Running the YOLO model at optimized "Skip Rates" to maintain high FPS.
  * HUD Rendering: Drawing the "Target Locked" brackets and high-visibility "Badge" labels (solid background with white text) for ID, speed, and alerts.
  * Grouped Logging: Managing the database to ensure each vehicle has only one persistent, updated entry in the log.
  * Performance Tuning: Balancing CPU load with video smoothness.

3. CALIBRATION TOOLS (SIDEBAR)
------------------------------
- Confidence Threshold: Fine-tunes AI sensitivity.
- Inference Resolution: Scales the AI "eye" (320px to 640px) to balance speed vs. accuracy.
- AI Skip Rate: Controls how often the AI "looks" at the video to ensure smooth playback on any hardware.
- Road Geometry Sliders: Allows the user to align the AI's "Divider" with the actual road.
- Speed Calibration: Allows fine-tuning of the KM/H math to match real-world road conditions.

This system represents a complete integration of computer vision, predictive analytics, and professional emergency response design.

4. PERFORMANCE OPTIMIZATION (V14 UPDATE)
----------------------------------------
- Display Scaling: Reduced default display width to 640px to minimize network latency and CPU overhead during frame rendering.
- UI Throttling: Optimized the main loop by reducing the update frequency of non-critical UI elements (metrics and advisories) to every 10 frames.
- Log Decoupling: Implemented high-performance log rendering that only processes the top 5 most recent violations and updates every 30 frames, preventing UI stutter.
- Inference Defaults: Set default AI resolution to 320px and Skip Rate to 5, ensuring fluid 30+ FPS playback on standard hardware.

5. SENTINEL SELF-REPAIR & OPTIMIZATION ENGINE (V15 UPDATE)
----------------------------------------------------------
- Adaptive FPS Control: Real-time monitoring of engine performance. If FPS drops below 12, the system automatically increases the AI Skip Rate to maintain video smoothness.
- Auto-Recovery Loop: The main engine is wrapped in a high-level recovery block. If a critical error or stream failure occurs, the system attempts to "rebuild" itself and restart the engine automatically.
- Memory Sanitization: Periodically clears stale tracking data and ID history to prevent memory leaks and ensure long-term stability.
- Health Monitoring UI: A dedicated "System Health" indicator in the sidebar provides real-time status updates and repair logs.

6. ENHANCED INTELLIGENCE & ANALYTICS (V16 UPDATE)
-------------------------------------------------
- Traffic Density Monitor: Real-time vehicle counting per lane (Left vs. Right), providing instant situational awareness of road congestion.
- Safety Distance HUD: Dynamic visual "Safety Lines" drawn between tailgating vehicles, complete with a real-time distance badge showing the gap in meters.
- Risk Trend Analytics: A persistent history buffer and live line chart that visualizes the Risk Index over the last 60 frames, allowing for predictive threat assessment.

7. DETECTION QUALITY OPTIMIZATION (V17 UPDATE)
----------------------------------------------
- High-Resolution Inference: Restored default `IMGSZ` to 640px to ensure the AI can detect small and distant vehicles with high precision.
- Tighter Tracking: Reduced default `AI_SKIP` to 3, ensuring the tracker updates more frequently to maintain ID stability and prevent lost tracks.
- Adaptive Safeguards: The Self-Repair Engine remains active, automatically adjusting skip rates if the higher resolution impacts video smoothness on specific hardware.

8. AMBULANCE PRIORITY MODE (V18 UPDATE)
---------------------------------------
- Emergency Vehicle Focus: When an ambulance is detected (or simulated), the system automatically hides all other vehicle markings to eliminate visual clutter for emergency responders.
- Evacuation HUD: A high-visibility, flashing red "EVACUATE" banner appears on the video feed to alert other drivers to clear the path.
- Priority Marking: The emergency vehicle is highlighted with a high-intensity flashing white/red box and a "PRIORITY: AMBULANCE" label.
- Tactical Siren: The siren trigger frequency is increased to provide a continuous audible warning during priority mode.

9. AUTOMATIC AMBULANCE DETECTION (V19 UPDATE)
---------------------------------------------
- ORB Recognition Engine: Uses advanced feature matching (ORB) to compare detected vehicles with the `assets/ambulance.webp` reference image in real-time.
- Auto-Priority Trigger: Automatically activates Ambulance Priority Mode when a visual match is confirmed, ensuring emergency vehicles are prioritized even without operator intervention.
- Intelligent Persistence: Once a vehicle is identified as an ambulance, the system "locks" its priority status for the entire duration of its presence on screen.
- Performance Throttling: Optimized recognition logic that only runs once per vehicle track to maintain 30+ FPS video quality.

10. AMBULANCE DETECTION REFINEMENT & UI OPTIMIZATION (V20 UPDATE)
----------------------------------------------------------------
- Multi-Stage Verification: Implemented a 3-stage validation engine (Aspect Ratio -> Color Filter -> Feature Matching) to eliminate false positives from trucks.
- Emergency Color Filter: Real-time HSV analysis that verifies the presence of "Emergency White" and "Medical Red" before flagging an ambulance.
- Stricter Feature Matching: Tightened ORB thresholds and increased match count requirements for 99% identification accuracy.
- UI Relocation: Moved the Tactical Advisory HUD to the top of the metrics column for zero-scroll visibility and immediate operator response.

11. MULTI-SOURCE VIDEO SELECTION (V21 UPDATE)
---------------------------------------------
- Dynamic Asset Discovery: Automatically scans the `assets/` directory for compatible video files (.mp4, .avi, .mov) at startup.
- Interactive Source Selector: A new sidebar dropdown allows the operator to switch between different traffic feeds instantly.
- Intelligent State Reset: Automatically clears violation logs, tracking data, and risk analytics when switching sources to ensure data integrity for the new scene.
- Real-Time Feedback: Provides a visual confirmation (toast notification) when a new video source is successfully loaded.

12. TRAFFIC SIGNAL INTELLIGENCE (V22 UPDATE)
--------------------------------------------
- Signal Recognition Engine: Automatically detects traffic lights (Class 9) and identifies their state (RED/GREEN) using HSV color analysis.
- Auto-Discovery Notification: Displays a "Traffic signal is detected" alert the moment a signal enters the frame.
- Red Light Violation Logic: Monitors a calibrated "Stop Line" and flags vehicles that cross it while the signal is RED.
- Signal HUD: Overlays the current signal state directly on the video feed with color-coded indicators.

13. PREMIUM COMMAND CENTER UI (V23 UPDATE)
------------------------------------------
- Glassmorphism Design: Implemented a modern, professional aesthetic with backdrop-blur effects and a refined "Electric Indigo" palette.
- Professional Signal Alert: Replaced standard warnings with a sleek, non-blinking "SIGNAL ACQUIRED" badge in the Tactical Advisory section.
- Polished HUD: Refined video overlays with thinner lines, semi-transparent vehicle labels, and high-contrast markings for maximum clarity.
- Command Center Typography: Standardized UI with 'Inter' and 'JetBrains Mono' for a sophisticated data-driven look.

14. STABILITY & PERFORMANCE POLISH
----------------------------------
- Signal Logic Guard: Implemented safety filters to prevent the system from calculating speed/safety data for static traffic signals, eliminating potential runtime crashes.
- Priority Filtering: Refined the ambulance priority logic to ensure only actual vehicles (not signals) are targeted for emergency tracking.
- Optimized Rendering: Streamlined the HUD drawing loop to maintain high FPS even with multiple overlays and glassmorphism effects active.

15. FINAL SYSTEM AUDIT & PRECISION REFINEMENTS
----------------------------------------------
- Enhanced Speed Precision: Increased velocity buffers to 30 frames and refined perspective-aware PPM for +/- 2km/h accuracy.
- Robust Signal Persistence: Implemented a state-aware memory buffer for traffic signals to prevent flickering and ensure red-light violations are never missed.
- Lane Sensitivity Tuning: Optimized vector analysis for wrong-way detection to eliminate false positives while maintaining 100% detection rate.
- Operator Feedback: Added 'System Ready' toast notifications and real-time self-repair logging for improved system transparency.

16. PEAK ACCURACY MODE (ULTRA-PRECISION)
----------------------------------------
- 100% Frame Analysis: Disables AI skipping to ensure every single frame is analyzed for zero-miss detection.
- Extended Temporal Buffers: Increases history and speed buffers to 60 frames for ultra-smooth and mathematically precise tracking.
- Max Resolution Enforcement: Locks the AI engine at 640px for the highest possible feature extraction.
- Real-time HUD Status: Provides visual confirmation to the operator when the system is in Peak Accuracy mode.

17. ADVANCED INTELLIGENCE MODULES (V24 UPDATE)
----------------------------------------------
The system has been expanded with 6 dedicated intelligence engines to handle complex tracking, prediction, and risk assessment.

MODULE 1: TRACKING ENGINE (tracking_engine.py)
----------------------------------------------
Responsibilities:
- Assigns persistent IDs to vehicles across frames.
- Calculates smooth velocity vectors (vx, vy) based on historical positions.
- Maintains a history buffer for stable tracking.

MODULE 2: TRAJECTORY ENGINE (trajectory_engine.py)
--------------------------------------------------
Responsibilities:
- Predicts future vehicle positions for the next 30-60 frames (1-2 seconds).
- Uses linear extrapolation based on current velocity vectors.
- Generates point sequences for drawing predicted paths.

MODULE 3: EMERGENCY ENGINE (emergency_engine.py)
------------------------------------------------
Responsibilities:
- Identifies emergency vehicles using visual classification and OCR (EasyOCR).
- Scans for keywords like "AMBULANCE", "108", "POLICE".
- Generates specific "Escape Routes" (predicted paths) for emergency vehicles.

MODULE 4: OBSTRUCTION ENGINE (obstruction_engine.py)
----------------------------------------------------
Responsibilities:
- Detects potential blockers of emergency vehicles.
- Compares the Emergency Escape Route with the predicted trajectories of civilian vehicles.
- Flags vehicles that will intersect the emergency path within a critical threshold.

MODULE 5: HEATMAP ENGINE (heatmap_engine.py)
--------------------------------------------
Responsibilities:
- Generates a spatial risk density map of the road.
- Accumulates heat based on vehicle presence and violation history.
- Applies temporal decay to visualize active threat zones.

MODULE 6: RISK ENGINE (risk_engine.py)
--------------------------------------
Responsibilities:
- Calculates a "Total Priority Score" for every vehicle.
- Aggregates multiple factors: Speed, Mass (Bus vs Bike), Obstruction Severity, and Heatmap location.
- Used to prioritize which vehicles require immediate operator attention.


18. HEATMAP V2: "AQI-STYLE" VISUALIZATION (V25 UPDATE)
------------------------------------------------------
- Gaussian Smoothing: Replaced block-based grid with organic, Gaussian-blurred heat blobs for a weather-map aesthetic.
- Smart Alpha Blending: Implemented dynamic transparency where low-risk areas remain clear, while high-risk zones glow intensely.
- Priority Weighting: Adjusted heat logic to prioritize specific threats:
  * WRONG LANE: 100% Intensity (Immediate Red)
  * OVERSPEED: 80% Intensity
  * OBSTRUCTION (AMBULANCE BLOCK): Scaled by severity (100%+)
- Color Mapping: Utilized 'JET' colormap (Blue->Green->Yellow->Red) to mimic standard Air Quality Index (AQI) or thermal imaging visualizations.

19. PREMIUM UI OVERHAUL (V26 UPDATE)
------------------------------------
- Cyberpunk/Sci-Fi Theme: Implemented a deep indigo/black color palette with neon accents (Electric Indigo #6366f1).
- Typography Upgrade: Standardized on 'Rajdhani' (Headers) and 'Inter/JetBrains Mono' (Body/Data) for a futuristic, data-driven look.
- Advanced CSS: Externalized styling to 'custom_css.txt' featuring:
  * Glassmorphism (Backdrop Blur)
  * Animated Cards (Hover effects, Slide-ins)
  * Glowing Borders and Text Shadows
- Layout Optimization: Refined spacing and component hierarchy for a cleaner "Command Center" experience.

20. INTELLIGENT SYSTEM LAUNCHER (V27 UPDATE)
--------------------------------------------
- Unified Startup: 'run_website.py' now handles the entire boot sequence (Asset Server + Streamlit App + Browser).
- Port Management: Automatically detects and kills zombie processes on ports 8000, 8002, and 8501 to prevent "Address already in use" errors.
- Self-Healing: If a previous session crashed, the launcher cleans up the environment before starting fresh.

21. FUTURE PATH PREDICTION UPGRADE (V28 UPDATE)
-----------------------------------------------
- Physics-Based Projection: Replaced placeholder logic with velocity-based vector projection for accurate path forecasting (2 seconds lookahead).
- Dynamic Visualization:
  * Replaced solid gray lines with "Sci-Fi" style dotted trails.
  * Color-Coded Risk: Paths turn RED for high-risk vehicles, default is Cyan/Gold.
  * Target Endpoints: Added circular markers to indicate predicted final position.

22. AI TRAFFIC ASSISTANT (V29 UPDATE)
-------------------------------------
- Smart Chatbot: Integrated a JavaScript-based AI assistant into the dashboard.
- Traffic-Only Logic: Filters out off-topic queries and provides strict, regulation-based answers (fines, rules, safety).
- Zero-Latency: Runs entirely client-side with a comprehensive knowledge base of Indian Traffic Laws (MV Act).

23. AI ASSISTANT EXPANSION (V30 UPDATE)
---------------------------------------
- Enhanced Knowledge Base: Added support for queries regarding congestion ("Heavy traffic"), construction zones, and escape routes.
- Situational Awareness: AI now provides advice on navigating crowded areas, dealing with road blockages, and selecting optimal routes.
- Environmental Intelligence: Added information on pollution zones (BS-III/BS-IV restrictions) and fog safety protocols.

24. INTERACTIVE COMMAND SYSTEM (V31 UPDATE)
-------------------------------------------
- Live Tactical Controls: Replaced static alerts with fully interactive map operations.
- Green Corridor: Visualizes emergency routes dynamically on the map with pulsing green overlays.
- Signal Override: Toggles traffic signals to GREEN at key intersections for emergency clearance.
- Patrol Dispatch: Simulates real-time patrol unit tracking from HQ to designated sectors.

25. INTEGRATED DISPATCH SYSTEM (V32 UPDATE)
-------------------------------------------
- One-Click Dispatch: Enable patrol deployment directly from Leaderboard alerts.
- Smart Map Markers: Upgraded map pins to show live Risk Scores, Threat Counts, and Dispatch controls.
- Dynamic Routing: Patrol units now intelligently route from HQ to any selected target zone with smooth animation.

26. AUTO-DISPATCH & LOW LATENCY (V33 UPDATE)
--------------------------------------------
- Automated Response System: Critical risks (Score > 90) now trigger automatic patrol dispatch to the affected zone.
- Latency Optimization: Reduced simulation update interval from 4s to 2s for improved real-time responsiveness.
- Faster Animations: Patrol units travel at 2x speed (30 steps vs 60 steps) for quicker on-scene arrival times.

27. ADVANCED GEO-INTELLIGENCE (V34 UPDATE)
------------------------------------------
- Real-Time Geocoding: Integrated OpenStreetMap Nominatim API to convert map coordinates into human-readable addresses instanty.
- Statistical Risk Analysis: Added Math.js library to calculate critical risk scores using Standard Deviation and Mean analysis.
- Heatmap Overlay: Implemented Leaflet.heat to visualize high-density violation zones with intuitive thermal gradients.

28. CUSTOM CORRIDOR BUILDER (V35 UPDATE)
----------------------------------------
- Interactive Route Creation: New "Build Custom Route" mode lets users manually define emergency paths on the map.
- Dynamic Activation: The "Trigger Emergency" system detects if a custom route exists and activates it instead of the default.
- Visual Feedback: Custom waypoints and pink construction lines guide the building process.

29. REAL-TIME SYSTEM STATISTICS (V36 UPDATE)
--------------------------------------------
- Dynamic Status Bar: Tracks Critical Alerts, Active Violations, Avg Response Time, and System Uptime in real-time.
- Active Monitoring: Stats are linked directly to the alert engine and map data, providing an instant health check of the traffic network.

30. UI POLISH & ALIGNMENT (V37 UPDATE)
--------------------------------------
- Dashboard Refinement: Unified container styling for Map and CCTV sections to match the main card design.
- Grid Alignment: Standardized spacing and alignment across all dashboard columns for a cleaner, professional look.

30. LAYOUT OPTIMIZATION (V37 UPDATE)
------------------------------------
- Dense Grid Layout: Reduced global padding and margins to maximize data density.
- Expanded Map View: Increased primary map height to 500px for better visibility of new geo-layers.
- Tighter Component Spacing: Optimized vertical rhythm for a professional command-center aesthetic.

31. COLUMNAR LAYOUT INTEGRATION (V38 UPDATE)
--------------------------------------------
- Seamless Vertical Flow: Integrated Risk and Response charts directly into the main grid columns.
- Gap Removal: Eliminated the horizontal whitespace below the AI Chatbot by stacking components continuously.

31. AI ASSISTANT EXPANSION (V38 UPDATE)
---------------------------------------
- Expanded Chat Interface: Enlarged the AI chat window to fill vertical sidebar space.
- Dynamic MV Act FAQs: Added a rotating ticker of trending Indian traffic queries to educate users.
- One-Click Asks: Users can click on trending FAQs to instantly query the AI.

32. ADVANCED MAP CAPABILITIES (V39 UPDATE)
------------------------------------------
- Map Search: Integrated Nominatim API for instant location search and fly-to navigation.
- Multi-View Switcher: Toggle between Street, Satellite, and Dark/Traffic modes.
- Emergency Context Awareness: Map automatically engages High-Contrast Dark Mode and reveals CCTV assets when Emergency Mode is triggered.

33. AI VOICE ASSISTANT (V40 UPDATE)
-----------------------------------
- Voice Command Support: Integrated Web Speech API for hands-free interaction.
- Unrestricted AI Engine: Removed "Traffic Only" firewall; assistant now handles general queries and chitchat.
- Adaptive Layout: Chat interface now dynamically expands to occupy all available vertical space in the command center.

34. VOICE API BUG FIX (V40.1 PATCH)
-----------------------------------
- Cross-Browser Compatibility: Added fallback for 'webkitSpeechRecognition' to support standard Chrome/Edge engines.
- Error Handling: Implemented granular notifications for microphone permission denials and no-speech events.

35. MAP GEODATA INSPECTOR (V41 UPDATE)
--------------------------------------
- Layer Hardening: Robust configurations for Satellite and Dark tile layers to prevent loading errors.
- Live Geodata UI: Floating 'Heads-Up Display' showing real-time GPS coordinates.
- Reverse Geocoding: Click-to-identify feature that fetches exact address strings from the global database.

36. FAQ & VOICE RESTORATION (V41.1 HOTFIX)
------------------------------------------
- Restored missing Trending FAQ ticker logic (rotateTicker).
- Hardened Voice Control: Added explicit try-catch blocks, console logging, and 'network' error handling for Web Speech API.
